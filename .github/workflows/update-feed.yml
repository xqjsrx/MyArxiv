name: Update

on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: "00 23 * * *" 

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      
      # 1. 准备环境 (提前到前面，因为 python 脚本需要依赖)
      - name: Install dependencies
        run: |
          pip install beautifulsoup4
          pip install openai requests

      # 2. 【关键】备份当前线上的网页 (为了非周日时恢复 AI 报告)
      - name: Backup existing index.html
        run: |
          # 替换成你自己的 Github Pages URL
          curl -L "https://xqjsrx.github.io/MyArxiv/index.html" -o backup.html || true
          echo "Backup downloaded."

      # 3. 下载并运行 ArxivFeed (生成今日新数据)
      - name: Download ArxivFeed
        env:
          GITHUB_PAT: ${{ github.token }}
          REPO: "NotCraft/ArxivFeed"
          VERSION: "latest"
          MATCH: "arxivfeed-.+-x86_64-unknown-linux-musl.tar.gz$"
          RENAME: "arxivfeed.tgz"
        shell: bash
        run: |
          curl -sL --fail \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${GITHUB_PAT}" \
              "https://api.github.com/repos/${REPO}/releases/${VERSION}" \
              | jq -r ".assets | .[] | select(.name | test(\"${MATCH}\")) | .url" \
              | tee asset.url
          curl -sL --fail \
            -H "Accept: application/octet-stream" \
            -H "Authorization: Bearer ${GITHUB_PAT}" \
              -o "${RENAME}" \
              "$(cat asset.url)"
          tar -zxvf arxivfeed.tgz --strip-components 1 $(tar tf arxivfeed.tgz | grep /arxivfeed)
          chmod +x arxivfeed

      - name: Build rss (Update cache and raw html)
        run: ./arxivfeed

      # 4. 判断日期
      - name: Check Day of Week
        id: check_day
        shell: bash
        run: |
          WEEKDAY=$(date +%u)
          echo "Current weekday: $WEEKDAY"
          if [ "$WEEKDAY" -eq 7 ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_gen_ai=true" >> $GITHUB_OUTPUT
          else
            echo "should_gen_ai=false" >> $GITHUB_OUTPUT
          fi

      # 5A. 情况一：周日 -> 生成新的 AI 报告
      - name: Sunday Generate New AI Report
        if: steps.check_day.outputs.should_gen_ai == 'true'
        env:
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "Sunday detected. Running AI evaluation..."
          python3 -u extract_papers_v2.py 
          python3 -u evaluate_papers_v2.1.py
          python3 -u inject_html_v2.py

      # 5B. 情况二：非周日 -> 恢复旧的 AI 报告
      - name: Mon-Sat Restore Old AI Report
        if: steps.check_day.outputs.should_gen_ai == 'false'
        run: |
          echo "Not Sunday. Restoring AI report from backup..."
          python3 restore_report.py

      # 6. 部署 (总是执行，确保 cache.json 更新)
      - name: List files in repository
        run: ls -R

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target
          force_orphan: true
